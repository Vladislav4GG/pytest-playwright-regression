name: E2E tests

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: "E2E scenario"
        required: true
        type: choice
        options:
          - all
          - registered_return
          - registered_order
          - guest_return
          - guest_order

      # -------- Registered profile selection --------
      registered_profile:
        description: "Registered profile (ignored for guest_* сценарії)"
        required: false
        type: choice
        options: [None, Vlad, Nadeem, Tufail, John, Yulia, Iryna, Custom]
        default: None

      registered_email_custom:
        description: "Registered email (only if Custom)"
        required: false
        default: ""

      registered_password_custom:
        description: "Registered password (only if Custom)"
        required: false
        default: ""

      # -------- Guest profile selection --------
      guest_profile:
        description: "Guest profile (ignored for registered_* сценарії)"
        required: false
        type: choice
        options: [None, Vlad, Nadeem, Tufail, John, Yulia, Iryna, Custom]
        default: None

      guest_email_custom:
        description: "Guest email (only if Custom)"
        required: false
        default: ""

permissions: read-all

jobs:
  run-e2e:
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}

      # Shipment API
      SHIPMENT_API_URL: ${{ secrets.SHIPMENT_API_URL }}
      SHIPMENT_API_USER: ${{ secrets.SHIPMENT_API_USER }}
      SHIPMENT_API_PASSWORD: ${{ secrets.SHIPMENT_API_PASSWORD }}
      SHIPMENT_INTEGRATION_KEY: ${{ secrets.SHIPMENT_INTEGRATION_KEY }}
      SHIPMENT_POST_PERSIST_HOOK: ${{ secrets.SHIPMENT_POST_PERSIST_HOOK }}

      PW_HEADLESS: "true"
      PW_TIMEOUT_MS: "15000"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Resolve credentials based on scenario + profiles
        shell: bash
        env:
          # Registered profiles (email/password)
          REG_VLAD_EMAIL:   ${{ secrets.REG_VLAD_EMAIL }}
          REG_VLAD_PASS:    ${{ secrets.REG_VLAD_PASS }}
          REG_NADEEM_EMAIL: ${{ secrets.REG_NADEEM_EMAIL }}
          REG_NADEEM_PASS:  ${{ secrets.REG_NADEEM_PASS }}
          REG_TUFAIL_EMAIL: ${{ secrets.REG_TUFAIL_EMAIL }}
          REG_TUFAIL_PASS:  ${{ secrets.REG_TUFAIL_PASS }}
          REG_JOHN_EMAIL:   ${{ secrets.REG_JOHN_EMAIL }}
          REG_JOHN_PASS:    ${{ secrets.REG_JOHN_PASS }}
          REG_YULIA_EMAIL:  ${{ secrets.REG_YULIA_EMAIL }}
          REG_YULIA_PASS:   ${{ secrets.REG_YULIA_PASS }}
          REG_IRYNA_EMAIL:  ${{ secrets.REG_IRYNA_EMAIL }}
          REG_IRYNA_PASS:   ${{ secrets.REG_IRYNA_PASS }}

          # Guest profiles (email only)
          GUEST_VLAD_EMAIL:   ${{ secrets.GUEST_VLAD_EMAIL }}
          GUEST_NADEEM_EMAIL: ${{ secrets.GUEST_NADEEM_EMAIL }}
          GUEST_TUFAIL_EMAIL: ${{ secrets.GUEST_TUFAIL_EMAIL }}
          GUEST_JOHN_EMAIL:   ${{ secrets.GUEST_JOHN_EMAIL }}
          GUEST_YULIA_EMAIL:  ${{ secrets.GUEST_YULIA_EMAIL }}
          GUEST_IRYNA_EMAIL:  ${{ secrets.GUEST_IRYNA_EMAIL }}
        run: |
          set -euo pipefail

          SCENARIO="${{ inputs.scenario }}"

          NEED_REGISTERED="false"
          NEED_GUEST="false"

          case "$SCENARIO" in
            all) NEED_REGISTERED="true"; NEED_GUEST="true" ;;
            registered_return|registered_order) NEED_REGISTERED="true" ;;
            guest_return|guest_order) NEED_GUEST="true" ;;
            *) echo "ERROR: Unknown scenario: $SCENARIO"; exit 1 ;;
          esac

          # ---------------- Registered ----------------
          if [ "$NEED_REGISTERED" = "true" ]; then
            PROFILE="${{ inputs.registered_profile }}"

            # Якщо юзер не вибрав профіль — впадемо з чіткою помилкою
            if [ "$PROFILE" = "None" ] || [ -z "$PROFILE" ]; then
              echo "ERROR: registered_profile is required for scenario=$SCENARIO"
              exit 1
            fi

            case "$PROFILE" in
              Vlad)   REG_EMAIL="$REG_VLAD_EMAIL";   REG_PASS="$REG_VLAD_PASS" ;;
              Nadeem) REG_EMAIL="$REG_NADEEM_EMAIL"; REG_PASS="$REG_NADEEM_PASS" ;;
              Tufail) REG_EMAIL="$REG_TUFAIL_EMAIL"; REG_PASS="$REG_TUFAIL_PASS" ;;
              John)   REG_EMAIL="$REG_JOHN_EMAIL";   REG_PASS="$REG_JOHN_PASS" ;;
              Yulia)  REG_EMAIL="$REG_YULIA_EMAIL";  REG_PASS="$REG_YULIA_PASS" ;;
              Iryna)  REG_EMAIL="$REG_IRYNA_EMAIL";  REG_PASS="$REG_IRYNA_PASS" ;;
              Custom)
                REG_EMAIL="${{ inputs.registered_email_custom }}"
                REG_PASS="${{ inputs.registered_password_custom }}"
                if [ -z "$REG_EMAIL" ]; then
                  echo "ERROR: registered_email_custom is required when registered_profile=Custom"
                  exit 1
                fi
                if [ -z "$REG_PASS" ]; then
                  echo "ERROR: registered_password_custom is required when registered_profile=Custom"
                  exit 1
                fi
                ;;
              *) echo "ERROR: Unknown registered_profile: $PROFILE"; exit 1 ;;
            esac

            if [ -z "${REG_EMAIL:-}" ] || [ -z "${REG_PASS:-}" ]; then
              echo "ERROR: Registered credentials are empty. Check secrets or Custom inputs."
              exit 1
            fi

            echo "STAGE_EMAIL=$REG_EMAIL" >> "$GITHUB_ENV"
            echo "STAGE_PASSWORD=$REG_PASS" >> "$GITHUB_ENV"
          fi

          # ---------------- Guest ----------------
          if [ "$NEED_GUEST" = "true" ]; then
            GPROFILE="${{ inputs.guest_profile }}"

            if [ "$GPROFILE" = "None" ] || [ -z "$GPROFILE" ]; then
              echo "ERROR: guest_profile is required for scenario=$SCENARIO"
              exit 1
            fi

            case "$GPROFILE" in
              Vlad)   G_EMAIL="$GUEST_VLAD_EMAIL" ;;
              Nadeem) G_EMAIL="$GUEST_NADEEM_EMAIL" ;;
              Tufail) G_EMAIL="$GUEST_TUFAIL_EMAIL" ;;
              John)   G_EMAIL="$GUEST_JOHN_EMAIL" ;;
              Yulia)  G_EMAIL="$GUEST_YULIA_EMAIL" ;;
              Iryna)  G_EMAIL="$GUEST_IRYNA_EMAIL" ;;
              Custom)
                G_EMAIL="${{ inputs.guest_email_custom }}"
                if [ -z "$G_EMAIL" ]; then
                  echo "ERROR: guest_email_custom is required when guest_profile=Custom"
                  exit 1
                fi
                ;;
              *) echo "ERROR: Unknown guest_profile: $GPROFILE"; exit 1 ;;
            esac

            if [ -z "${G_EMAIL:-}" ]; then
              echo "ERROR: Guest email is empty. Check secrets or Custom input."
              exit 1
            fi

            echo "GUEST_EMAIL=$G_EMAIL" >> "$GITHUB_ENV"
          fi

          echo "Credentials resolved for scenario=$SCENARIO"

      - name: Run E2E tests
        shell: bash
        run: |
          set -e

          case "${{ inputs.scenario }}" in
            all)
              pytest -m e2e -q --alluredir=allure-results
              ;;
            registered_return)
              pytest -m "e2e and e2e_registered and e2e_return" -q --alluredir=allure-results
              ;;
            registered_order)
              pytest -m "e2e and e2e_registered and e2e_order" -q --alluredir=allure-results
              ;;
            guest_return)
              pytest -m "e2e and e2e_guest and e2e_return" -q --alluredir=allure-results
              ;;
            guest_order)
              pytest -m "e2e and e2e_guest and e2e_order" -q --alluredir=allure-results
              ;;
            *)
              echo "Unknown scenario: ${{ inputs.scenario }}"
              exit 1
              ;;
          esac

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            allure-results
            artifacts